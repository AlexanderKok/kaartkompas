## Feature 0007: Phase 3 follow-ups, Unit Tests, and Phase 4 refinements

### Context

- Feature 0006 delivered unified document intake, V2 parse queue with retries, a basic analysis pipeline, a status endpoint, and initial PDF parsing (digital + OCR fallback).
- Outstanding items from the review: unify URL path to V2 queue end-to-end, ensure queues drain properly, add tests, and refine digital PDF parsing with column detection and layout metadata.

### Scope

- Backend follow-ups to complete the V2 pipeline for URL-based docs and tighten queue behavior.
- Add unit tests in `server` for state transitions, routing, triage detection, queue flows with retries, and analysis metrics/status progression.
- Developer setup note for OCR dependencies.
- Phase 4 (nice-to-have) refinements to add column detection + `layoutMetadata` to the digital PDF parser.

---

### Files to edit/create

- `server/src/api.ts`
- `server/src/services/analysisQueue.ts`
- `server/src/services/urlParser.ts`
- `server/src/services/parsers/pdfParser.ts`
- `server/src/services/parseQueue.ts` (deprecate/archive)
- Tests (new):
  - `server/src/__tests__/stateMachine.spec.ts`
  - `server/src/__tests__/parseRouter.spec.ts`
  - `server/src/__tests__/documentTriage.spec.ts`
  - `server/src/__tests__/parseQueueV2.spec.ts`
  - `server/src/__tests__/analysisQueue.spec.ts`

---

### Backend changes

1) Public URL flow → unified V2 queue

- In `server/src/api.ts`:
  - For `POST /api/v1/public/parse-url`: remove dependence on legacy `parseQueue`. After `triageDocument({ type: 'url', source: body.url })`, transition the new `documentId` to `queued` and enqueue via `parseQueueV2.enqueueParseJob(documentId, 'v1')`.
  - Response: include `documentId` and `parseJobId` (V2), and stop returning legacy `jobId` once migrated.
  - Similarly, in `POST /api/v1/protected/menus/parse-url`: triage URL into `documents`, set `queued`, enqueue V2, and return `documentId` + `parseJobId`. Keep restaurant records behavior unchanged.

- Deprecation path:
  - Mark `server/src/services/parseQueue.ts` as deprecated; remove imports/usages from API after confirming V2 parity. Archive or delete the file and adjust types/callers accordingly.

2) Analysis queue draining verification (already patched)

- Ensure `server/src/services/analysisQueue.ts` processes all queued jobs by scheduling the next tick when `queue.length > 0` after a job completes. No additional behavior changes needed.

3) URL parser PDF branches behavior

- In `server/src/services/urlParser.ts`, either:
  - Remove PDF branches from `parseUrl` to avoid unused/erroneous paths (preferred, since V2 handles PDFs directly), or
  - Implement PDF handling that downloads the URL to bytes: for `pdf_digital` fetch the URL, convert to base64, then call `parseDigitalPdf('', base64)`; for `pdf_ocr`, call `parseScannedPdf(url)`.

4) Status endpoint (optional refinement)

- In `server/src/api.ts` status route, optionally select the latest `analysis_runs` across all parse runs for the `documentId` instead of limiting to the latest parse run’s analysis. Alternative: return arrays of runs to let the FE pick.

---

### Phase 4 refinements (digital PDF parsing)

Target: `server/src/services/parsers/pdfParser.ts` → `parseDigitalPdf`

- Column detection (gap-based clustering):
  1) After extracting tokens and grouping into y-bands, compute `x` positions for each token in a band.
  2) For each page (or globally), sort unique `x` positions; split into columns where the gap between successive `x` exceeds a threshold (e.g., mean gap + 1–2 standard deviations or a fixed px threshold like 40–60px).
  3) Assign each token/line to the nearest column; record `columnBoundaries`.

- Heading detection refinement:
  - Keep current heuristics (uppercase, no price, short length). Add y-gap detection: if a line is followed by a large positive y distance and has no price, treat as a heading.

- Item association:
  - For lines with a price, set item name as the left segment before the price; inherit `currentCategory`. For multi-column layouts, restrict name/price associations within the same column.

- Emit `layoutMetadata` in the parse result:
  - `layoutMetadata: { columnCount, columnBoundaries, bandSize, totalLines, linesSample?: string[] }`
  - Keep `menuItems`, `categories`, `parseMethod`, `confidence` unchanged.

Note: pdf.js extraction doesn’t expose font size via the simple `transform` path in our current usage; we’ll rely on text heuristics and y-gaps for heading detection.

---

### Unit tests (backend)

- Runner: `vitest` (already present). Place tests under `server/src/__tests__`.

1) `stateMachine.spec.ts`
  - Valid transitions succeed: `uploaded → queued → parsing → parsed → analyzing → analyzed → done`.
  - Invalid transitions throw (e.g., `parsed → uploaded`, `done → parsing`).
  - Use an in-memory/fake DB or mock `getDatabase` to track `documents.status`.

2) `parseRouter.spec.ts`
  - Verify `routeToParser(documentType, mimeType)` mapping for: `digital_pdf`, `scanned_pdf`, `html_static`, `html_dynamic`.
  - Assert unsupported combos throw.

3) `documentTriage.spec.ts`
  - `detectDocumentType` for PDF with/without text: mock `pdfinfo`/`pdftotext` exec responses to return text/no-text and assert `digital_pdf` vs `scanned_pdf`.
  - HTML case: `mimeType=text/html` → `html_static`.
  - Ensure errors default PDFs to `digital_pdf` as implemented.

4) `parseQueueV2.spec.ts`
  - File doc path: mock `retrieveDocument` to return sample PDF bytes; assert `parse_runs` inserted, `documents` transitions, and analysis job enqueued on success.
  - URL doc path: mock `UrlParser.detectDocumentType` to return strategies; assert `inputType='url'`, strategy selection, and retries/backoff (simulate two failures then success). Verify new `runId` per retry and final statuses.

5) `analysisQueue.spec.ts`
  - Given a sample `parse_runs.rawOutput`, generate `analysis_runs` and verify metrics: `totalItems`, `avgPrice`, `minPrice`, `maxPrice`, `categoryDistribution`, `qualityScore`.
  - Assert `analyzing → analyzed → done`. Failure path: throw once or twice and ensure retries/backoff; on final failure transition `failed_analysis`.

Mocks/fixtures guidance:
- Mock `getDatabase` with an in-memory implementation for `documents`, `parse_runs`, `analysis_runs` that satisfies the Drizzle interface used.
- Mock `fileStorage.retrieveDocument` to return `Buffer` from a small fixture.
- For OCR/CLI calls, mock `execAsync` and `Tesseract.recognize` to avoid system dependencies in CI.

---

### Optional cleanup

- Switch public URL endpoint(s) fully to enqueue `ParseQueueV2` after triage; remove legacy `parseQueue` usage and return values.
- Deprecate/archive `server/src/services/parseQueue.ts` and callers. Remove imports and types once routes are migrated.

---

### Dev setup

- OCR dependencies for scanned PDFs:
  - macOS: `brew install poppler` (provides `pdfinfo`, `pdftotext`, `pdftoppm`).
  - Ensure `tesseract.js` is installed via workspace deps (already added). No extra Node deps required.

Env reminders:
- `server/.env`:
  - `FIREBASE_PROJECT_ID=demo-project`
  - `FIREBASE_AUTH_EMULATOR_HOST=localhost:5503`
- `ui` Vite env: `VITE_API_URL` should point to the API base (e.g., `http://localhost:5500`).

---

### Notes

- No DB migrations required; we only read/write existing `documents`, `parse_runs`, `analysis_runs` tables. Tests should not rely on real DB; use mocks.
- Keep response payloads small; do not expose `rawOutput` in APIs.


