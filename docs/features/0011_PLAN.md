Context

We need a follow-up enrichment script that runs after `server/src/scripts/ingest-osm.ts`. OSM often lacks or mislabels the official restaurant website. Current fallback `server/src/services/competitive/googleSearch.ts` is quota-limited. The new script should: (1) deterministically guess candidate domains from the restaurant name and validate against location/address, and (2) query a less restrictive search engine (DuckDuckGo) with conservative rate limiting, then verify candidates before storing results. Results should be persisted to `ext_restaurants` and audited in `ext_restaurant_checks` without DB schema changes.

Relevant files and functions

- `server/src/scripts/ingest-osm.ts`
  - Entry point for OSM ingestion; the new script will consume the run output (via `runId` or `location`).
- `server/src/services/competitive/pipeline.ts`
  - Shows existing validation flow and how we persist to `ext_restaurants` and `ext_restaurant_checks`.
  - Reuse ideas like per-host limiting and URL validation ordering.
- `server/src/services/competitive/urlResolution.ts`
  - Reuse `normalizeUrl(url)`, `validateUrl(url)`, `isSocial(url)`.
- `server/src/services/competitive/menuDiscovery.ts`
  - Reuse HTTP headers/timeouts style and `cheerio` parsing pattern for fetching and parsing HTML.
- `server/src/services/competitive/googleSearch.ts`
  - Reuse domain scoring and negative keywords list; extend for DuckDuckGo.
- `server/src/schema/competitive.ts`
  - Data sink: `ext_restaurants` (fields `websiteUrl`, `websiteDiscoveryMethod`, `websiteEffectiveUrl`, `websiteHttpStatus`, `websiteIsValid`, etc.) and audit table `ext_restaurant_checks`.
- `server/src/lib/env.ts`
  - Add new env keys; cannot modify `.env` here, but document needed keys.

New files to create

- `server/src/scripts/enrich-osm-websites.ts`
  - CLI script to run after an ingest; targets rows in `ext_restaurants` missing a valid website.
- `server/src/services/competitive/duckDuckGoSearch.ts`
  - Lightweight HTML search against DuckDuckGo with conservative rate limit; returns ranked links.
- `server/src/services/competitive/nameToDomain.ts`
  - Deterministic domain guesser from restaurant name (+ optional city), producing candidate URLs.
- `server/src/services/competitive/siteVerification.ts`
  - HTML-based verifier computing a match score of a candidate site against name/address/phone.
- (Optional) `server/src/services/competitive/rateLimiter.ts`
  - Simple token-bucket or queued rate limiter used by DuckDuckGo fetch; alternatively inline in the script.

CLI interface (enrich-osm-websites.ts)

- Inputs:
  - `--run-id <id>`: focus on a specific ingest run. If omitted, and `--location` is provided, select the most recent run for that location. If neither is provided, operate on the latest completed run.
  - `--limit <N>`: maximum restaurants to process (default: unlimited or env-capped).
  - `--methods <list>`: comma-separated subset of methods to apply (`guess,duckduckgo`) default `guess,duckduckgo`.
  - `--rate <rps>`: override search rate (default from env).
  - `--min-score <0-100>`: verification score threshold (default from env, e.g., 60).
- Selection:
  - Target rows where `websiteIsValid = false` OR `websiteUrl IS NULL`.
  - Optionally skip rows with prior `ext_restaurant_checks` success for `website`.
- Output:
  - Updates `ext_restaurants` with validated website, sets `websiteDiscoveryMethod` to `heuristic` or `duckduckgo`, updates HTTP fields, and sets `websiteIsValid = true`.
  - Inserts an `ext_restaurant_checks` row per candidate attempt, with `method`=`heuristic` or `duckduckgo` and `target`=`website`.

Algorithm details

1) Deterministic domain guessing (nameToDomain)

- Normalize inputs:
  - `normalizedName = name.toLowerCase()`, remove diacritics, remove punctuation/spaces, collapse repeats.
  - Also prepare hyphenated variant for nicer hostnames.
- Generate host candidates using TLD set `[.nl, .com, .eu, .be]` (configurable):
  - `<normalizedName>.nl`, `<hyphenatedName>.nl`, then same for other TLDs.
  - If city present, also try `normalizedName + city` variants.
  - Add suffix variants: `normalizedName + 'restaurant'` and `'restaurant' + normalizedName` (hyphenated and concatenated) for each TLD.
- Convert to URLs: `https://<host>/` and, if needed, `http://` fallback only if HTTPS fails.
- For each candidate:
  - Use `validateUrl(url)` to ensure it is reachable, non-social, and likely HTML (or redirecting to HTML).
  - If reachable HTML, run `siteVerification.computeMatchScore(html, url, name, addressParts)`.
  - Persist an `ext_restaurant_checks` row with `method='heuristic'` and outcome.
  - If score ≥ threshold, accept as final website.

2) DuckDuckGo search (duckDuckGoSearch)

- Build query: `"<name> <city>"` (include city if available). Use language/region bias: `kl=nl-nl`. Apply negative site filters: `-site:facebook.com -site:instagram.com -site:tripadvisor.com -site:thefork.nl -site:ubereats.com -site:yelp.com -site:thuisbezorgd.nl -site:deliveroo.nl`.
- Endpoint: `https://duckduckgo.com/html/?q=<encoded>&kl=nl-nl` (HTML results for easy parsing; avoids JS).
- Rate limit: default 0.2 requests/second (1 every 5s) with jitter; exponential backoff on HTTP 429 or detection of block/captcha markers.
- Parse result list anchors; produce candidates with simple ranking:
  - Base rank: reuse `scoreDomain(url, name)` logic (prefer `.nl`, host containing name; penalize negative keywords).
  - Promote hosts that match name more tightly and those with city tokens in title/snippet (if easily available from HTML).
- For top N (e.g., N=5) candidates:
  - Validate each via `validateUrl`; skip socials/aggregators.
  - Fetch homepage and compute `siteVerification` score.
  - Audit in `ext_restaurant_checks` (`method='duckduckgo'`).
  - Accept first candidate with score ≥ threshold; otherwise continue.

Verification scoring (siteVerification)

- Inputs: fetched HTML, final URL, expected `name`, address parts (`street`, `housenumber`, `postcode`, `city`), and optional phone.
- Steps:
  - Extract text: `<title>`, `<h1>`, and visible body text (bounded length) using `cheerio`.
  - Normalize text (lowercase, remove diacritics/punctuation).
  - Compute features and scores (example weights; configurable via env):
    - Hostname includes normalized name (exact or with hyphens): +25
    - Title/H1 fuzzy similarity to name (≥0.7): +20
    - Street name present AND housenumber present: +25
    - Postcode present (NL pattern `[1-9][0-9]{3}\s?[A-Z]{2}`): +15
    - City name present: +10
    - Phone digits overlap (≥6 consecutive): +10
    - Penalize if page contains many aggregator keywords: −20
  - Sum to 0–100; accept if ≥ threshold (default 60).

Concurrency and politeness

- Apply conservative concurrency for outbound HTTP:
  - Per-host concurrency limit (e.g., 5) like in `pipeline.ts` for `validateUrl` and page fetches.
  - Global rate limit for DuckDuckGo requests (token bucket or queued with delays). Do not parallelize DDG calls.
- Use headers consistent with existing code: `User-Agent: getEnv('OSM_USER_AGENT') || 'kaartkompas/unknown-contact'`.
- Respect `HTTP_DEFAULT_TIMEOUT_MS` for all requests.

Persistence and updates

- For every attempted candidate (from heuristic or DDG): insert into `ext_restaurant_checks` with fields:
  - `target='website'`, `candidateUrl`, `method='heuristic' | 'duckduckgo'`, `httpStatus`, `contentType`, `effectiveUrl`, `isValid=(score>=threshold)`, `errorMessage` if any.
- On acceptance, update the corresponding row in `ext_restaurants`:
  - `websiteUrl`, `websiteEffectiveUrl`, `websiteHttpStatus`, `websiteContentType`, `websiteIsValid=true`, `websiteIsSocial=false`, `websiteLastCheckedAt=now()`, `websiteDiscoveryMethod='heuristic' | 'duckduckgo'`.

Environment variables to add (user to set in .env)

- `FALLBACK_SEARCH_RATE_RPS` (default `0.2`): Max DuckDuckGo requests per second.
- `FALLBACK_SEARCH_MAX_CANDIDATES` (default `5`): Top N links from DDG to validate.
- `FALLBACK_VERIFY_MIN_SCORE` (default `60`): Acceptance threshold for verification.
- `FALLBACK_TLDS` (default `.nl,.com,.eu,.be`): TLDs for deterministic domain guessing.
- `FALLBACK_ENABLE_GUESS` (default `true`), `FALLBACK_ENABLE_DDG` (default `true`).
- Reuse existing: `HTTP_DEFAULT_TIMEOUT_MS`, `OSM_USER_AGENT`.

Edits and additions (no code, just where/what)

- Add `server/src/scripts/enrich-osm-websites.ts`
  - Parse CLI args.
  - Query DB for target `ext_restaurants` rows for a run or location.
  - Execute methods in order: `guess` then `duckduckgo` (configurable).
  - Use per-host concurrency for URL validations; serialize DDG queries with rate limit.
  - Persist checks and updates as described.
  - Log a run summary similar to `ingest-osm.ts` (counts: examined, guessed_success, ddg_success, updated, skipped).
- Add `server/src/services/competitive/nameToDomain.ts`
  - Export: `generateDomainCandidates(name: string, city?: string, tlds: string[]): string[]`.
- Add `server/src/services/competitive/duckDuckGoSearch.ts`
  - Export: `search(name: string, city?: string, opts): Promise<string[]>`.
  - Options include rate limiter and negative keywords.
- Add `server/src/services/competitive/siteVerification.ts`
  - Export: `computeMatchScore(url: string, html: string, expected: { name: string; street?: string; housenumber?: string; postcode?: string; city?: string; phone?: string; }): number`.
  - Helper: `extractVisibleText($: CheerioAPI): string` and a light fuzzy matcher.
- (Optional minor) If reusing domain scoring, factor common `scoreDomain(url, name)` into a small util (or duplicate inside DDG module).

Operational notes

- The script is intentionally decoupled from the main pipeline to avoid interleaving DDG traffic with Overpass/API calls and to allow separate budget/scheduling.
- Run example:
  - Latest run: `pnpm --filter server tsx src/scripts/enrich-osm-websites.ts`.
  - Specific run: `pnpm --filter server tsx src/scripts/enrich-osm-websites.ts --run-id cr_20250812_xxx`.
  - Limit and slower rate: `pnpm --filter server tsx src/scripts/enrich-osm-websites.ts --limit 200 --rate 0.1`.

Phasing (small)

- Phase 1 (deterministic guessing): implement `nameToDomain`, `siteVerification`, and the script wiring; ship with `guess` method only.
- Phase 2 (DDG search): implement `duckDuckGoSearch` with rate limiting and backoff; integrate into the script and measure yields.


