## Feature 0009: Competitive Data Pipeline (OSM → Website URL → Menu URL) – PLAN

### Description
Build a competitive data pipeline that, given a `location_input` (for this iteration: "The Hague"), fetches all restaurants from OpenStreetMap (OSM), validates/normalizes each restaurant’s website URL, and discovers a `menu_url` by scanning the homepage for links/text like "menu" or "kaart". Implement a fallback workflow to search Google when OSM’s `url`/`website` is missing or invalid. End with a run that produces a dataset (~850 restaurants for The Hague) with functioning website URLs and discovered menu URLs plus a summarized report.

---

### Scope and Architecture
- **Providers**: OSM Overpass API for places; Nominatim for geocoding/bounds; Google Search (Custom Search API or SerpAPI) for URL fallback.
- **Pipeline**: Location → OSM query → candidate website URL(s) → validation/normalization → fallback search if needed → homepage crawl → menu URL detection → persist results → report/CSV export.
- **Storage**: New dedicated tables for external places and discovery runs, decoupled from existing `restaurants` (which requires `userId` and `url`).
- **Interfaces**: Admin-only Hono routes to start a run, check status, and export CSV; a script to run locally for The Hague.

---

### Data Layer (Phase 1)
Add a new schema file `server/src/schema/competitive.ts` with the following tables (names can be adjusted to match conventions):

- `ext_crawl_runs` – one row per ingestion run
  - `id` (text, pk)
  - `location_query` (text) – e.g., "The Hague"
  - `provider` (text) – e.g., "overpass"
  - `area_id` (text, nullable) – OSM area/relation id if resolved
  - `bbox` (jsonb, nullable) – bounding box used for the query
  - `started_at`, `completed_at` (timestamp)
  - `status` (text: pending, running, completed, failed)
  - `stats` (jsonb) – totals (seen, with_osm_website, validated, google_fallback_success, with_menu_url)
  - `error_message` (text, nullable)

- `ext_restaurants` – external/competitive entities
  - `id` (text, pk) – generated id (not OSM id)
  - `run_id` (text, fk → `ext_crawl_runs.id`)
  - `source` (text) – "osm"
  - `source_element_type` (text: node|way|relation)
  - `source_element_id` (bigint or text)
  - `name` (text)
  - `addr_street`, `addr_housenumber`, `addr_postcode`, `addr_city`, `addr_country` (text, nullable)
  - `latitude`, `longitude` (decimal)
  - `phone` (text, nullable)
  - `osm_tags` (jsonb) – full tag blob for traceability
  - `website_url` (text, nullable) – final chosen website URL
  - `website_discovery_method` (text: osm|google)
  - `website_effective_url` (text, nullable) – after redirects
  - `website_http_status` (integer, nullable)
  - `website_content_type` (text, nullable)
  - `website_is_social` (boolean, default false) – facebook/instagram/etc.
  - `website_is_valid` (boolean, default false)
  - `website_last_checked_at` (timestamp, nullable)
  - `menu_url` (text, nullable)
  - `menu_discovery_method` (text: link_text|header|sitemap|search)
  - `menu_http_status` (integer, nullable)
  - `menu_content_type` (text, nullable)
  - `menu_is_pdf` (boolean, default false)
  - `menu_is_valid` (boolean, default false)
  - `menu_last_checked_at` (timestamp, nullable)
  - `created_at`, `updated_at` (timestamp, default now())

- `ext_restaurant_checks` – audit log of validation attempts
  - `id` (text, pk)
  - `restaurant_id` (text, fk → `ext_restaurants.id`)
  - `target` (text: website|menu)
  - `candidate_url` (text)
  - `method` (text: osm|google|crawl)
  - `http_status` (integer, nullable)
  - `content_type` (text, nullable)
  - `effective_url` (text, nullable)
  - `is_valid` (boolean)
  - `error_message` (text, nullable)
  - `checked_at` (timestamp, default now())

Note: Keep existing `server/src/schema/restaurants.ts` unchanged; the competitive pipeline writes exclusively to the new `ext_*` tables.

Migration: add a new drizzle SQL migration under `server/drizzle/` to create these tables.

---

### Services and Modules (Phase 2)
Create new modules under `server/src/services/competitive/`:

- `nominatimClient.ts`
  - `geocodeToAreaOrBbox(locationQuery: string): Promise<{ areaId?: string; bbox: [number, number, number, number] }>`
  - Use Nominatim to resolve "The Hague" to an OSM relation/area and bounding box. Include `User-Agent` header.

- `overpassClient.ts`
  - `fetchRestaurants(areaOrBbox): Promise<OverpassRestaurant[]>`
  - Build an Overpass query for amenity=restaurant within the resolved area/bbox. Return nodes/ways/relations with `tags` and centroids.
  - Extract OSM fields: `name`, `website`, `url`, `contact:website`, `contact:url`, `phone`, `addr:*`.

- `urlResolution.ts`
  - `pickBestOsmWebsite(tags): Candidate[]` – rank `website|url|contact:*` and detect socials (facebook/instagram/etc.).
  - `validateUrl(url): Promise<ValidationResult>` – HEAD→GET fallback, follow redirects, capture status/content-type, deem invalid if only social or non-HTML endpoints (unless it’s the final fallback and still serves a homepage).
  - `normalizeUrl(url): string` – ensure scheme, strip tracking params, lowercase host, preserve path.

- `googleSearch.ts`
  - `searchOfficialSite(name: string, city: string): Promise<string | null>` – try Google Custom Search or SerpAPI. Apply domain heuristics (penalize review/delivery sites and socials; prefer .nl TLD; prefer domain containing normalized name).

- `menuDiscovery.ts`
  - `discoverMenuUrl(homepageUrl): Promise<MenuDiscoveryResult>` – fetch homepage HTML, parse anchors/nav for link text or attributes containing "menu", "menukaart", "kaart" (and obvious variants). Resolve relative URLs, validate candidate endpoints, prefer HTML/PDF pages likely to be menus. Optionally scan for common slugs like `/menu`, `/menukaart`, `/kaart`.

- `pipeline.ts`
  - Orchestrates: geocode → overpass → per-place URL resolution → validation → google fallback if needed → homepage crawl → menu discovery → persist results and checks → update run stats.
  - Concurrency: limit to ~5-10 in-flight network ops to respect remote rate limits.

Supporting types: add to `server/src/types/competitive.ts` (new) – request/response and entity types used by services.

---

### API and Scripts (Phase 3)
- Hono routes in `server/src/api.ts` (admin-only):
  - `POST /api/v1/admin/competitive/ingest` – body: `{ location: string }` (default: "The Hague"). Creates a new `ext_crawl_runs` row, kicks off the pipeline (background), returns `runId`.
  - `GET /api/v1/admin/competitive/runs/:runId` – returns status and `stats` for the run.
  - `GET /api/v1/admin/competitive/export?runId=...` – streams CSV of results with key fields: name, address, lat/lon, `website_url`, `website_is_valid`, `menu_url`, `menu_is_valid`, http statuses, discovery methods.

- CLI script under `server/src/scripts/ingest-osm-the-hague.ts`:
  - Runs the pipeline for `location = "The Hague"`, waits to completion, prints summary, and writes CSV to `docs/temp_files/combined_restaurants_<timestamp>.csv`.

Authorization: reuse existing `authMiddleware` for admin routes or guard via environment flag if needed.

---

### Algorithms – Step by Step
1) Resolve location
   - Call Nominatim for "The Hague"; prefer relation→area. Capture `areaId` and `bbox`. If area lookup fails, fall back to bbox-only query.

2) Overpass fetch (amenity=restaurant)
   - Query restaurants within the area/bbox: `nwr["amenity"="restaurant"](area.searchArea)` (or bbox variant). `out:json` with tags and center.
   - For each element, collect: `name`, address tags, `phone`, website candidates from `website|url|contact:*`.

3) Candidate website selection
   - Rank candidates: prefer `website`, then `contact:website`, then `url`, then `contact:url`.
   - Disqualify or deprioritize socials (facebook, instagram, tiktok, linkedin). Keep them flagged for auditing only.
   - Normalize candidates; dedupe by effective hostname.

4) Validation and normalization
   - Try HEAD with redirect follow; on 405/4xx/timeout, try GET. Record `http_status`, `content_type`, `effective_url`.
   - Consider valid when 2xx and `text/html` (or typical homepage content). 3xx chains allowed if terminal page is acceptable.

5) Google fallback (when OSM is missing/invalid or social-only)
   - Query: `"<name>" The Hague` with filters to demote review/delivery/social sites (negative keywords: facebook, instagram, tripadvisor, thuisbezorgd, deliveroo, uber eats, yelp, thefork, etc.).
   - Rank results by domain heuristics and re-validate the top 3 until one passes.

6) Menu URL discovery
   - Fetch homepage HTML; parse anchors/nav/header/footer.
   - Match by text/aria-label/title containing "menu", "menukaart", "kaart" (case-insensitive; accommodate diacritics/spacing). Resolve relative paths.
   - Validate candidate endpoints (prefer HTML/PDF; record `is_pdf`). Choose highest-confidence match; fall back to common slugs (`/menu`, `/menukaart`, `/kaart`) if not found in DOM.

7) Persistence and reporting
   - Insert/Upsert into `ext_restaurants` (one row per OSM place) keyed by combination of `run_id` + (`source_element_type`,`source_element_id`).
   - Append `ext_restaurant_checks` for each validation attempt (website/menu).
   - Update `ext_crawl_runs.stats` cumulatively.
   - Export CSV with final fields for analysis.

Rate limiting & resilience
   - Respect OSM/Overpass/Nominatim policies. Add per-host concurrency caps and delays. Backoff on 429/5xx. Identify via `User-Agent`.

---

### Files to Create/Change
- New
  - `server/src/schema/competitive.ts`
  - `server/src/services/competitive/nominatimClient.ts`
  - `server/src/services/competitive/overpassClient.ts`
  - `server/src/services/competitive/urlResolution.ts`
  - `server/src/services/competitive/googleSearch.ts`
  - `server/src/services/competitive/menuDiscovery.ts`
  - `server/src/services/competitive/pipeline.ts`
  - `server/src/types/competitive.ts`
  - `server/src/scripts/ingest-osm-the-hague.ts`

- Modify
  - `server/src/api.ts` – add admin routes under `/api/v1/admin/competitive/*`
  - `server/drizzle/*.sql` – migration file for new tables
  - `README.md` and/or `server/README.md` – add env setup and usage notes

---

### Environment and Config
- Add to `.env` (server):
  - `OSM_USER_AGENT=<your-app-name/your-email>` – required for Nominatim/Overpass etiquette
  - One of:
    - `GOOGLE_CSE_ID=<id>` and `GOOGLE_API_KEY=<key>` (Custom Search API), or
    - `SERPAPI_KEY=<key>` (SerpAPI)
  - Optional tuning:
    - `HTTP_DEFAULT_TIMEOUT_MS=15000`
    - `COMPETITIVE_MAX_CONCURRENCY=5`

Note: We cannot edit `.env` directly; please add these values.

---

### Testing and Validation (Phase 4)
- Unit tests (`server/src/__tests__/competitive/*.spec.ts`):
  - `urlResolution` – social detection, normalization, HEAD/GET fallback logic (mock `fetch`).
  - `menuDiscovery` – DOM link extraction against fixtures with Dutch labels ("menukaart", "kaart").
  - `googleSearch` – ranking heuristics and negative keyword filters (mock provider responses).
  - `overpassClient` – query-building snapshots and minimal parsing logic (don’t hit live API).

- Integration test (mocked I/O):
  - End-to-end pipeline on a small fixture set to verify run accounting, persistence to `ext_*` tables, and CSV assembly.

- Operational run (for acceptance):
  - Execute `ingest-osm-the-hague.ts` locally to hit live OSM and Google provider with throttling.
  - Expected: ~850 restaurants. Produce summary:
    - total_seen, with_osm_website, validated_website, google_fallback_success, with_menu_url, export_path.
  - Verify "functioning url and a website URL" by asserting for each row:
    - `website_url` not null AND `website_is_valid = true`.
    - If OSM provided a URL, optionally cross-check its validity separately in the checks log.

Deliverables
  - CSV at `docs/temp_files/combined_restaurants_<timestamp>.csv` with columns: name, address fields, lat, lon, website_url, website_effective_url, website_http_status, website_is_valid, website_discovery_method, menu_url, menu_http_status, menu_is_valid, menu_discovery_method.
  - Run summary (also persisted in `ext_crawl_runs.stats`).

---

### Phasing
- Phase 1: Schema + migrations (`ext_*` tables)
- Phase 2: Clients/services (`nominatim`, `overpass`, `urlResolution`, `googleSearch`, `menuDiscovery`)
- Phase 3: Orchestrator pipeline + admin routes + CLI script
- Phase 4: Tests + The Hague operational run + CSV/report

---

### Notes and Considerations
- Keep network usage polite: identify via `OSM_USER_AGENT`, apply concurrency caps, and backoff on errors.
- Prefer amenity=restaurant only to meet the requirement precisely.
- When multiple candidate websites exist, prefer domains with `.nl` and name-similarity to the restaurant name; penalize marketplaces and social links.
- For SPAs where menu links render client-side, consider a future headless fetcher if coverage is insufficient in practice.


