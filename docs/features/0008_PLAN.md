# Feature 0008: Testing & Parser Reliability Hardening - PLAN

## Description
Tighten test coverage and behavior for the unified parsing/analysis pipeline, validate digital PDF layout metadata, add optional end-to-end route tests, finalize legacy deprecation, refine PDF parsing heuristics, and update docs/CI/dev env notes. This plan is based on the provided "What’s next" checklist.

## Scope of Changes

### 1) Strengthen Parse Queue V2 tests
- **Files**:
  - `server/src/__tests__/parseQueueV2.spec.ts`
  - `server/src/services/parseQueueV2.ts`
  - `server/src/schema/documents.ts`
- **Add assertions**:
  - Verify a `parse_runs` row is inserted when a job starts and updated on completion/failure.
    - Assert presence of: `id`, `documentId`, `parserVersion`, `parseMethod`, `status`, `startedAt`, `completedAt`, `rawOutput/confidence/errorMessage` as applicable.
    - Use the in-memory `parseRuns` array in the existing test mocks to assert inserts/updates.
  - Add a success-path test that asserts analysis enqueue happens after a completed parse.
    - Use `__test__drainOnce()` and a `vi.spyOn(analysisQueue, 'enqueueAnalysisJob')` to ensure it is called only after the corresponding `parseRuns.status` becomes `completed`.
  - Keep using fake timers to deterministically advance backoff (already used) and drain with the test drain helper.

### 2) Digital PDF layout metadata tests
- **Files**:
  - `server/src/services/parsers/pdfParser.ts`
  - `server/src/__tests__/pdfParser.digital.spec.ts` (new)
- **Tests to add**:
  - Unit tests that call `parseDigitalPdf('', <base64>)` with a mocked `pdfjs-dist` to yield deterministic `textContent.items`.
  - Assert that `result.layoutMetadata` exists with:
    - `columnCount` (>= 1)
    - `columnBoundaries` (array when multi-column is detected)
    - `linesSample` (non-empty)
    - `totalLines` and `bandSize` present
  - Create a two-column scenario in the mock (x positions separated by the current heuristic) and assert `columnCount >= 2` and non-empty `columnBoundaries`.
  - Include a single-column scenario to ensure `columnCount` falls back to 1.

### 3) Analysis queue failure path tests (retries/backoff)
- **Files**:
  - `server/src/__tests__/analysisQueue.spec.ts`
  - `server/src/services/analysisQueue.ts`
- **Tests to add**:
  - Simulate errors thrown within `processJob` and use fake timers to assert exponential backoff retries up to `maxRetries`.
  - After exceeding `maxRetries`, assert the document transitions to `failed_analysis` via `transitionDocumentStatus` and a final failed `analysis_runs` record is written with `status='failed'` and `errorMessage`.
  - Add a metrics-path assertion for success-case runs, confirming `metrics.totalItems`, `avgPrice`, `minPrice`, `maxPrice`, and a positive `qualityScore` are emitted.

### 4) End-to-end route tests 
- **Files**:
  - `server/src/api.ts`
  - `server/src/__tests__/routes.parse-url.spec.ts` (new)
- **Public route**: `POST /api/v1/public/parse-url`
  - Assert JSON includes: `documentId` and V2 `parseJobId` (named `parseJobId` in response). Confirm no legacy `jobId` field appears.
  - Mock `verifyRecaptcha` to return true; mock DB in-memory same as other tests; spy on `parseQueueV2.enqueueParseJob` to return a stable id.
- **Protected route**: `POST /api/v1/protected/menus/parse-url`
  - Same assertions as public route, with `Authorization` mocked by `authMiddleware` test helpers or by stubbing the middleware to inject `user`.

### 5) Cleanup (legacy queue removal and small route updates)
- **Files**:
  - `server/src/api.ts`
  - `server/src/services/parseQueue.ts` (legacy)
- **Actions**:
  - Remove the commented legacy `parseQueue` import line and any remaining references. Ensure URL routes only use `parseQueueV2`. 
  - If `parseQueue.ts` is no longer used anywhere, mark it deprecated in the header and/or schedule removal once any dependent scripts are migrated.

### 6) Route updates for source tracking
- **Files**:
  - `server/src/api.ts` (both public and protected URL routes)
  - `server/src/services/documentTriage.ts`
  - `server/src/services/urlParser.ts`
  - `server/src/schema/restaurants.ts`
- **Change**:
  - After triage returns `{ documentType, processingStrategy }`, immediately update the newly created `restaurant_menu_sources` row for that URL (`sourceId` known in the route) with:
    - `sourceType` (pdf/html/js) inferred from triage detection
    - `documentType` (e.g., `digital_pdf`/`scanned_pdf`/`html_static`)
    - `parseMethod` (e.g., `pdf_digital`/`pdf_ocr`/`html`/`javascript`)
  - Note: Currently the unified V2 queue operates on `documents` only and doesn’t link back to `restaurant_menu_sources`. Using the triage results in the route is sufficient to reflect accurate detection on the source record.

### 7) PDF parsing refinements (Phase 4)
- **Files**:
  - `server/src/services/parsers/pdfParser.ts`
  - `server/src/__tests__/pdfParser.digital.spec.ts`
- **Changes**:
  - Tune column detection thresholds: keep `threshold = Math.max(40, mean + std)` but add a min-gap and consider right-aligned price clustering to avoid false splits.
  - Improve heading detection via y-gap (already partially implemented). Add stricter uppercasing + price absence and a band-jump heuristic configurable constant.
  - Add tests covering:
    - Single-column menu with headings and prices
    - Two-column layout with distinct x-gap and right-aligned prices
    - Headings recognized across y-gap breaks

### 8) CI stability
- **Files**:
  - `server/vitest.config.ts`
  - `server/package.json`
- **Changes**:
  - Ensure CI uses `vitest --run` (non-watch) and reasonable timeouts (`testTimeout`, `hookTimeout`).
  - Prefer fake timers for backoff-related tests and the provided drain helper for queues.

### 9) Dev environment and OCR/triage dependencies documentation
- **Files**:
  - `server/README.md`
  - Root `README.md`
- **Add**:
  - OCR and PDF utilities required by parsing and triage:
    - `poppler` tools: `pdftoppm`, `pdfinfo`
    - `tesseract` (for OCR)
  - Install hints:
    - macOS: `brew install poppler tesseract`
    - Ubuntu/Debian: `apt-get update && apt-get install -y poppler-utils tesseract-ocr`
  - Env reminders:
    - Server: `RECAPTCHA_SECRET_KEY`, `DATABASE_URL` (or local/embedded alternatives), optional `RUNTIME`
    - UI: `VITE_API_URL`, `VITE_RECAPTCHA_SITE_KEY`
  - Firebase emulator notes (local dev) and how API URL is configured in UI.

### 10) Possible follow-ups (not required for this PR)
- Standardize `documents.sourceType` values to use `file` instead of `upload` (requires migration + triage change).
- Consider adding a link between `documents` and `restaurant_menu_sources` to improve traceability of source records created during route handling.

## Acceptance Criteria
- **ParseQueueV2 tests** assert a `parse_runs` insert/update and that analysis enqueue happens only after successful parse completion.
- **PDF digital parser tests** verify `layoutMetadata` emission (column count/boundaries, lines sample) for digital PDFs.
- **AnalysisQueue tests** confirm retries/backoff behavior and transition to `failed_analysis` after max retries.
- **Route tests** validate public `/parse-url` and protected `/menus/parse-url` return `documentId` and V2 `parseJobId` (no legacy `jobId`).
- **Cleanup** eliminates any legacy queue usage from URL routes.
- **Docs** clearly state OCR/PDF dependencies and dev env variables for local/CI.
- **Refinements** include threshold/heading detection improvements with tests demonstrating multi-column association.
