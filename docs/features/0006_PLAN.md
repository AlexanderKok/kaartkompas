## Feature 0006: Phase 3 wiring and Phase 4 parsing kickoff

### Context

- We just added triage, storage, documents schema (phase 2 of 0005_plan.md). Unified document intake exists via `server/src/services/documentTriage.ts` and persists to `documents` with `storagePath`, `sourceType`, and `documentType`.
- This plan completes Phase 3 (state machine + queue separation + analysis wiring) and starts Phase 4 (layout-aware PDF parsing with OCR fallback), without breaking existing FE flows or returning raw bytes.

### Scope (from request)

- Ensure parse queue processes both file and URL documents correctly. For URL-based documents, confirm `ParseQueueV2` sets `inputType` and routes via `UrlParser`. Add retries and backoff on failures.
- Extend analysis pipeline: implement a basic analysis that reads `parse_runs.rawOutput` and produces structured `analysis_runs.analysisResults` (items, categories, metrics). On success: `analyzing → analyzed → done`. On failure: `analyzing → failed_analysis`.
- Add a GET endpoint to fetch document/parse/analysis status by `documentId` for frontend polling.
- Phase 4 parsing improvements in `server/src/services/parsers/pdfParser.ts`:
  - Digital PDFs: replace mock `parseDigitalPdf` with `pdfjs-dist` extraction to collect text blocks with positions; heuristics for columns/categories/price alignment; compute confidence.
  - OCR fallback: use Poppler `pdftoppm` to rasterize pages and `tesseract.js` to OCR; combine text; compute OCR confidence.
  - Respect `routeToParser` and triage decision; maintain current return shape.
- Add tests for state transitions and queues; unit test `detectDocumentType`, `routeToParser`, and transitions.
- Runtime deps: `pnpm add pdfjs-dist tesseract.js`.
- Env: `server/.env` has `FIREBASE_PROJECT_ID=demo-project`, `FIREBASE_AUTH_EMULATOR_HOST=localhost:5503`. Frontend `VITE_API_URL` points at the API.

---

## Phase 3: State Machine + Queue Separation (Final Wiring)

### Files to edit/create

- `server/src/services/stateMachine.ts`
- `server/src/services/parseQueueV2.ts`
- `server/src/services/analysisQueue.ts`
- `server/src/api.ts` (status endpoint)
- (Optional) deprecate/archive `server/src/services/parseQueue.ts` once URL flow is fully migrated

### Current references

- Status transitions defined in `stateMachine.ts` include: `uploaded → queued → parsing → parsed → analyzing → analyzed → done`; failure branches: `failed_parsing`, `failed_analysis` with re-entry to `queued`/`analyzing`.
- `ParseQueueV2` exists and creates a `parse_runs` row, runs parser by strategy, and enqueues `analysisQueue` on success. It currently defaults `inputType: 'file'` and for URL documents routes via `UrlParser` only at runtime.
- `AnalysisQueue` inserts a placeholder `analysis_runs` row and tries transitioning to `analyzing`, but does not yet produce structured results nor finalize `analyzed → done`.

### Required edits

1) `ParseQueueV2` — file and URL parity, retries, backoff

- When enqueuing, set `inputType` based on `documents.sourceType`:
  - If `sourceType === 'url'`: `inputType: 'url'`, `inputSource: documents.storagePath` (the URL)
  - If `sourceType === 'upload'`: `inputType: 'file'`, `inputSource: documents.storagePath` (local path)
- In `processJob`:
  - If `sourceType === 'url'`, compute `strategy` using `UrlParser.detectDocumentType(url)` unless both `mimeType` and `documentType` are stored, in which case call `routeToParser(documentType, mimeType)`.
  - Execute by strategy:
    - `pdf_digital`: load bytes via `retrieveDocument(storagePath)` then call `parseDigitalPdf('', base64)`
    - `pdf_ocr`: call `parseScannedPdf(storagePath)`
    - `html`/`javascript`: `urlParser.parseUrl(storagePath, strategy)`
  - Persist run outcome in `parse_runs`: `status` (`completed`/`failed`), `confidence`, `rawOutput`, `errorMessage` on failure; maintain `metadata.strategy`.
  - Transition document: success → `parsed`; failure → `failed_parsing`.
  - On success, `analysisQueue.enqueueAnalysisJob(runId, 'v1')`.
- Retries/backoff:
  - Add in-memory retry tracking on the job: `retryCount` (start 0), `maxRetries` (default 3), backoff schedule (e.g., 2^retryCount * 5s, capped at 60s).
  - On failure, if `retryCount < maxRetries`: requeue with incremented `retryCount` and `setTimeout` backoff; if exceeded, keep `parse_runs.status = 'failed'` and document `status = 'failed_parsing'` with `statusReason`.
  - Ensure idempotency: generating a new `runId` per re-attempt is acceptable; link via `documentId`.

2) `AnalysisQueue` — basic structured analysis and status progression

- Inputs: `parseRunId`, `analysisVersion`.
- Steps:
  - Transition document to `analyzing` (best-effort, ignore if already `analyzing`).
  - Read the `parse_runs` row by `parseRunId` and its `rawOutput` (the parse result).
  - Compute:
    - `items`: normalized array with `{ name, description?, price?, currency?, category? }` using the parse result fields. If parse result contains layout blocks, derive probable categories by proximity and headings.
    - `categories`: set of categories detected with counts.
    - `metrics`: `totalItems`, `avgPrice`, `minPrice`, `maxPrice`, `categoryDistribution`, and a simple `qualityScore` derived from parse `confidence` and item completeness.
  - Persist `analysis_runs` row: `status = 'completed'`, `analysisResults`, `metrics`, `completedAt`.
  - Transition document: `analyzing → analyzed`. After the first completed analysis for the document, transition to `done` to signal UI availability.
  - On failure: insert `analysis_runs.status = 'failed'`, set `errorMessage`, transition `analyzing → failed_analysis`.
- Retries/backoff: mirror `ParseQueueV2` approach with `retryCount` and exponential backoff up to 3 tries before finalizing `failed_analysis`.

3) API — status endpoint for polling

- Add to `server/src/api.ts` under public routes:
  - GET `/api/v1/documents/:documentId/status`
  - Returns JSON with:
    - `document`: `{ id, status, statusReason, documentType, sourceType, createdAt, updatedAt }`
    - `parseRun`: latest run by `startedAt` (or `completedAt`)
      - `{ id, status, parseMethod, confidence, errorMessage, startedAt, completedAt }`
    - `analysisRun`: latest run by `startedAt` (or `completedAt`)
      - `{ id, status, analysisVersion, metrics, errorMessage, startedAt, completedAt }`
  - Must not include any raw file bytes; omit `rawOutput` from response.

4) Optional cleanup — deprecate legacy URL pipeline

- Once the public URL endpoint is switched to enqueue `ParseQueueV2` (and `documents` are created via triage), archive or remove `server/src/services/parseQueue.ts` and related callers. In the interim, keep both to avoid breaking existing flows.

---

## Phase 4: PDF Parsing Improvements

### Files to edit/create

- `server/src/services/parsers/pdfParser.ts`
- (Uses) `server/src/services/parseRouter.ts`, `server/src/services/documentTriage.ts`

### Digital PDF parsing (`parseDigitalPdf`)

- Library: `pdfjs-dist`.
- Input: base64 content (already available in `ParseQueueV2` via `retrieveDocument(storagePath)` → Buffer → base64).
- Algorithm:
  1) Load PDF with `pdfjs-dist` in Node (set `PDFJS.GlobalWorkerOptions.workerSrc` or use `getDocument` with Node stream).
  2) For each page (cap N pages for perf, e.g., first 5–8 pages):
     - Extract `textContent.items` with `transform` matrices to compute absolute positions.
     - Build text blocks: group tokens by y-bands (e.g., within 6–8 px), sort by x.
     - Column detection: cluster x-positions into 1–3 columns via k-means on `x` or gap-based thresholding.
     - Price detection: regex for currency/price patterns (`/(\d+[\.,]\d{2})/`, currency signs), associate nearest-left name text within same y-band or preceding bands.
     - Category detection: detect headings by larger font size/uppercase and y-gap; propagate as current category for following items until next heading.
  3) Emit `menuItems` with `{ name, description?, price?, currency?, category? }`, `categories` list, and `layoutMetadata` (column count, blocks, associations). Compute `confidence` from ratio of items with both name and price and signal quality of layout grouping.
  4) Return `ParseResult` preserving fields used by downstream analysis. Do not include raw bytes.

### OCR fallback (`parseScannedPdf`)

- Tools: Poppler `pdftoppm` (dev dependency via `brew install poppler`) + `tesseract.js`.
- Algorithm:
  1) Rasterize first N pages with `pdftoppm -png` to a temp directory; constrain max pages and DPI for performance (e.g., 150–200 DPI).
  2) For each PNG, run `tesseract.js` OCR; collect page texts and average confidences.
  3) Combine text; apply simple heuristics to extract item lines and prices (line splitting + price regex + category headings via all-caps or trailing colon).
  4) Build `menuItems`, `categories`; compute OCR `confidence` from Tesseract average confidence and item extraction success.
  5) Clean up temp images.
  6) Return `ParseResult` with `parseMethod: 'pdf_ocr'`.

### Integration requirements

- Respect `routeToParser(documentType, mimeType)` and `triageDocument` decisions; `ParseQueueV2` routes accordingly.
- Ensure error paths set informative `errorMessage` for storage in `parse_runs`.
- Keep return shape stable to avoid breaking existing FE.

---

## Tests

Note: If no test runner is configured in `server`, add `vitest` (dev) and place tests under `server/src/__tests__`. This plan lists test targets and fixtures; implementation can mock DB and storage.

- `stateMachine.spec.ts`
  - Valid transitions succeed: `uploaded → queued → parsing → parsed → analyzing → analyzed → done`.
  - Invalid transitions throw (e.g., `parsed → uploaded`).
- `parseRouter.spec.ts`
  - `routeToParser` mapping correctness for `digital_pdf`, `scanned_pdf`, `html_static`, `html_dynamic` across MIME types.
- `documentTriage.spec.ts`
  - `detectDocumentType` behavior for PDF with/without text, and HTML with/without SPA indicators.
- `parseQueueV2.spec.ts`
  - File doc path: uses `retrieveDocument` mock; asserts `parse_runs` written, document `status` transitions, and analysis enqueue on success.
  - URL doc path: asserts `inputType: 'url'`, `UrlParser.detectDocumentType` usage, and retries/backoff behavior (simulate two failures then success).
- `analysisQueue.spec.ts`
  - Generates `analysis_runs` from sample `rawOutput`; asserts metrics and `analyzing → analyzed → done` progression; asserts failure path `failed_analysis` with retries.

---

## Dependencies and environment

- Runtime: `pnpm add pdfjs-dist tesseract.js` (run in the repo root or within `server/` workspace as appropriate).
- System: macOS devs install Poppler: `brew install poppler` (provides `pdfinfo`, `pdftotext`, `pdftoppm`).
- Env:
  - `server/.env`: `FIREBASE_PROJECT_ID=demo-project`, `FIREBASE_AUTH_EMULATOR_HOST=localhost:5503`.
  - `ui/.env` or vite env: `VITE_API_URL` set to the API base (e.g., `http://localhost:5500`).

---

## Data and migrations

- `documents`, `parse_runs`, `analysis_runs` are already defined in `server/src/schema/documents.ts`. Do not duplicate migrations; only add indexes if proven necessary by query profiles.

---

## Success criteria (for validation)

- Upload or URL creates `documents`, enqueues parse, then analysis; statuses flow: `uploaded → queued → parsing → parsed → analyzing → analyzed → done`.
- No APIs return raw bytes; payloads respect size limits.
- Digital PDF yields structured items with layout metadata; scanned PDFs run OCR and return text-derived items.
- Status endpoint returns combined document/parse/analysis status for frontend polling.

---

## Implementation checklist

- [x] Update `ParseQueueV2` to set `inputType` from `documents.sourceType`, handle URL routing, and add retries/backoff.
- [x] Persist `parse_runs.errorMessage` and transition `failed_parsing` on terminal failure.
- [x] Implement structured analysis in `AnalysisQueue` with metrics; set `analyzing → analyzed → done`; failure path `analyzing → failed_analysis` with retries.
- [x] Add GET `/api/v1/documents/:documentId/status` to `server/src/api.ts`.
- [x] Replace mock `parseDigitalPdf` with `pdfjs-dist` layout-aware extraction; implement `parseScannedPdf` with `pdftoppm` + `tesseract.js`.
- [ ] Add unit tests per the Tests section.
- [x] Install runtime deps; confirm env variables and Poppler install.


