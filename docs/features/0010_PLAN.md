## Better menu crawling in `server/src/services/competitive/menuDiscovery.ts`

### Context
Improve menu URL discovery so that for every website present in `docs/temp_files/combined_restaurants_20250806_200450.csv`, we robustly find a valid menu page. Keep in mind that eventually we want to turn this into a pipeline, moving away from loose CSV files to a database. Expand DOM scanning, broaden matching (Dutch/English variants), add slug and sitemap fallbacks, and tighten validation and prioritization. Keep existing pipeline shape and persistence.

### Files to change or create
- `server/src/services/competitive/menuDiscovery.ts`
  - Expand DOM scanning (header/nav/main/footer + body) and attribute matching (text, `title`, `aria-label`, `data-*`).
  - Diacritic-insensitive, case-insensitive regex matching for Dutch/English keywords.
  - Relative URL resolution, fragment/mailto/tel filtering.
  - HEAD→GET fallback with redirect following; content sniffing when content-type missing.
  - Return enriched `method` values: `header` | `nav` | `footer` | `link_text` | `slug` | `sitemap`.
  - De-duplicate candidates by effective host+path; prioritize sources per confidence; prefer HTML over PDF when both exist.

- `server/src/services/competitive/pipeline.ts`
  - Add small per-host concurrency control (e.g., 5) on top of current overall concurrency when validating websites and discovering menus. Keep existing website validation logic intact and call the improved `discoverMenuUrl`.
  - Persist existing menu fields (already present) and insert a menu check row as done now.

- `server/src/types/competitive.ts`
  - Update `MenuDiscoveryResult['method']` union to include `footer`, `nav`, and `slug` (keep `link_text`, `sitemap`). Preserve backwards compat by accepting `slug_guess` internally but emitting `slug`.

- Tests: `server/src/__tests__/competitive/menuDiscovery.spec.ts` (new)
  - Unit tests covering header/nav/footer/body anchor discovery, slug fallback, sitemap fallback, PDF detection, and HEAD→GET fallback.

- Optional dependency (server package): add `fast-xml-parser` for sitemap parsing.

### Algorithm details
1) Input and setup
   - Input: homepage URL (string).
   - Timeout: use `HTTP_DEFAULT_TIMEOUT_MS` via `getEnv` (default 15000ms). Use `AbortController`.
   - Default headers: `'User-Agent': getEnv('OSM_USER_AGENT') || 'kaartkompas/unknown-contact'`.

2) Fetch homepage and parse DOM
   - Perform `GET homepageUrl` with redirect following and timeout.
   - Parse HTML with `cheerio`.
   - Build a list of anchor elements from these scopes, in priority order:
     1. `header a`
     2. `nav a`
     3. `footer a`
     4. All other `a` elements in `main` or `body` (exclude previous scopes).
   - For each anchor, collect:
     - `href`
     - Visible text content (trimmed)
     - Attributes: `title`, `aria-label`, and any attribute where name starts with `data-` (concatenate values).
   - Normalize each collected string for matching: lowercase + diacritic-insensitive (Unicode NFD + remove combining marks).

3) Matching
   - Use robust, case-insensitive, diacritic-insensitive regex that covers these Dutch/English variants:
     - Include: `menu`, `menukaart`, `kaart`, `eten`, `dranken`, `drankkaart`, `wijnkaart`, `borrel`, `lunch`, `diner`, `gerechten`, `assortiment`, `kaart-en-prijzen`, `menu-en-prijzen`, `food`, `drinks`, `beverage`, `wine list`.
   - Match against the concatenation of: normalized text, `title`, `aria-label`, all `data-*` values.
   - If matched, consider anchor a candidate with scope-derived `method`:
     - From `header` → `method: 'header'`
     - From `nav` → `method: 'nav'`
     - From `footer` → `method: 'footer'`
     - Otherwise (body/main) → `method: 'link_text'`

4) Candidate URL normalization and filtering
   - Resolve `href` relative to `new URL(homepageUrl)`.
   - Skip if:
     - Not http(s)
     - `mailto:` or `tel:`
     - Only a fragment (`#...`) or results in same-page fragment-only URL
   - Normalize and store candidate with fields: `absoluteUrl`, `sourceMethod` (as above).

5) Validation per candidate
   - For each candidate (in priority order gathered above):
     - Attempt `HEAD` request; if non-2xx or 405/4xx/invalid, fallback to `GET`.
     - Consider valid if final HTTP status is 2xx AND content is HTML or PDF.
       - Use `content-type` header to detect HTML (`text/html`, `application/xhtml+xml`) or PDF (`application/pdf`).
       - If header missing/ambiguous, sniff first ~2048 bytes: check for `<html`/`<!doctype html` (HTML) or `%PDF-` (PDF).
     - On success, return immediately with:
       - `url` (effective URL), `httpStatus`, `contentType`, `isPdf`, `isValid: true`, `method: sourceMethod`.

6) Slug fallback (if no anchor candidate validated)
   - Try, in order, resolving against base: `/menu`, `/menukaart`, `/kaart`, `/eten`, `/dranken`, `/drankkaart`, `/wijnkaart`, `/lunch`, `/diner`, `/food`, `/drinks`, `/menu-en-prijzen`, `/kaart-en-prijzen`.
   - For each, validate using the same HEAD→GET and sniffing logic. On success, return with `method: 'slug'`.

7) Sitemap fallback (if no slug success)
   - Try loading `{base}/sitemap.xml`; if 404 or invalid, try `{base}/sitemap_index.xml` and enumerate child sitemaps.
   - Parse XML with `fast-xml-parser` (lenient mode). Extract `loc` URLs under `<urlset><url><loc>` and/or nested sitemaps under `<sitemapindex><sitemap><loc>`.
   - For each URL in the sitemap(s), include if its path text matches the same keyword regex (diacritic-insensitive). Validate as above. On success, return with `method: 'sitemap'`.

8) De-duplication and prioritization
   - Maintain a `Set` keyed by `host + path` of effective URLs to avoid duplicates across methods.
   - Priority order:
     1. Anchors in `header`/`nav`/`footer` (in that order)
     2. Anchors in body/main (`link_text`)
     3. `sitemap`
     4. `slug`
   - If both HTML and PDF candidates exist at the same confidence level, prefer HTML. Only prefer PDF if no good HTML is found.

9) Return failure
   - If no valid candidate found, return `{ isValid: false }`.

### Concurrency and timeouts
- Respect `HTTP_DEFAULT_TIMEOUT_MS` in all requests with `AbortController`.
- Add per-host concurrency limiting in `server/src/services/competitive/pipeline.ts`:
  - Keep overall `options.maxConcurrency` behavior.
  - Implement a small semaphore per host (e.g., Map<host, { active: number; queue: Task[] }>) targeting a limit of 5 concurrent requests per host across website validation and menu discovery.

### Types and persistence
- `server/src/types/competitive.ts`:
  - Update `MenuDiscoveryResult['method']` to: `'link_text' | 'header' | 'nav' | 'footer' | 'sitemap' | 'slug'`.
  - Optionally accept `'slug_guess'` internally and map to `'slug'` when persisting.
- `server/src/schema/competitive.ts` already has fields: `menuUrl`, `menuDiscoveryMethod`, `menuHttpStatus`, `menuContentType`, `menuIsPdf`, `menuIsValid`. No schema changes needed.
- `server/src/services/competitive/pipeline.ts` already persists these fields; ensure the new `method` strings are written as-is.

### Tests
Create `server/src/__tests__/competitive/menuDiscovery.spec.ts` with Vitest.
- Mocks: stub `global.fetch` with `vi.fn()` to simulate:
  - Anchor discovery in `header` (e.g., `<header><a href="/menukaart">Menukaart</a></header>`), `nav`, `footer`, and body.
  - Attributes matching: `title`, `aria-label`, `data-menu`, mixed diacritics (e.g., `Wijnkaart`, `Dránkkaart`).
  - Relative URL resolution and skipping `mailto:`, `tel:`, and `#fragment`.
  - HEAD→GET fallback: `HEAD` returns 405, `GET` returns 200 with HTML or PDF.
  - Content sniffing: missing `content-type` header but body begins with `%PDF-` or contains `<html>`.
  - Slug fallback: return success on `/menu` then stop; test full ordering list.
  - Sitemap fallback: serve `/sitemap.xml` and `/sitemap_index.xml` with URLs matching keywords; validate selection and method.
  - De-duplication: duplicate links across header and body should be requested once and the higher-priority method returned.

### Acceptance criteria
- Running `pnpm tsx src/scripts/ingest-osm.ts --location "The Hague"` in `server/` yields a materially higher `with_menu_url` count (target >25% initially).
- Exported CSV (`docs/temp_files/combined_restaurants_<timestamp>.csv`) contains, for matched rows:
  - `menu_url` populated
  - `menu_is_valid` = `true`
  - `menu_discovery_method` populated (`header`/`nav`/`footer`/`link_text`/`sitemap`/`slug`)
- Unit tests for `menuDiscovery` pass and cover the scenarios above.

### Implementation notes
- Keep error handling defensive; treat network/parse failures as non-fatal and continue fallbacks.
- Use a shared helper for normalized matching: `toMatchKey = s.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase()`.
- Build the keyword regex once and reuse.
- Ensure redirect chains do not accidentally downgrade HTTPS when building effective URLs; always re-resolve relative URLs against the latest `URL` during parsing.


